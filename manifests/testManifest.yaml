# hook-test.yaml
---
# Create a namespace for our test
apiVersion: v1
kind: Namespace
metadata:
  name: hook-test
---
# Service Account for the hooks
apiVersion: v1
kind: ServiceAccount
metadata:
  name: hook-sa
  namespace: hook-test
  annotations:
    argocd.argoproj.io/hook: PreSync,PostDelete
---
# Role for secret management
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: secret-manager
  namespace: hook-test
  annotations:
    argocd.argoproj.io/hook: PreSync,PostDelete
rules:
- apiGroups: [""]
  resources: ["secrets", "configmaps"]
  verbs: ["create", "get", "delete", "list"]
- apiGroups: ["batch"]
  resources: ["jobs"]
  verbs: ["get", "list"]
---
# RoleBinding for the service account
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: hook-sa-binding
  namespace: hook-test
  annotations:
    argocd.argoproj.io/hook: PreSync,PostDelete
subjects:
- kind: ServiceAccount
  name: hook-sa
  namespace: hook-test
roleRef:
  kind: Role
  name: secret-manager
  apiGroup: rbac.authorization.k8s.io
---
# Simplified hook job with both PreSync and PostDelete annotations
apiVersion: batch/v1
kind: Job
metadata:
  name: dual-phase-hook
  namespace: hook-test
  annotations:
    argocd.argoproj.io/hook: PreSync,PostDelete
    #argocd.argoproj.io/hook-delete-policy: HookSucceeded
spec:
  ttlSecondsAfterFinished: 100
  template:
    spec:
      serviceAccountName: hook-sa
      containers:
      - name: kubectl
        image: bitnami/kubectl:latest
        command:
        - /bin/sh
        - -c
        - |
          echo "Running hook job..."
          
          # Create a simple ConfigMap to log that this job ran
          TIMESTAMP=$(date +%s)
          JOB_POD_NAME=$(hostname)
          
          cat <<EOF | kubectl apply -f -
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: hook-execution-log-${TIMESTAMP}
            namespace: hook-test
          data:
            pod: "${JOB_POD_NAME}"
            timestamp: "${TIMESTAMP}"
            message: "Dual-phase hook executed"
          EOF
          
          # Detect which phase we're in by checking for the existence of the secret
          if kubectl get secret test-secret -n hook-test --ignore-not-found; then
            echo "Secret exists - this is the PostDelete phase"
            
            # Add a label to the ConfigMap to indicate phase
            kubectl label configmap hook-execution-log-${TIMESTAMP} -n hook-test phase=PostDelete
            
            # Clean up the secret
            echo "Cleaning up secret in PostDelete phase"
            kubectl delete secret test-secret -n hook-test
            echo "Secret deletion completed"
          else
            echo "Secret doesn't exist - this is the PreSync phase"
            
            # Add a label to the ConfigMap to indicate phase
            kubectl label configmap hook-execution-log-${TIMESTAMP} -n hook-test phase=PreSync
            
            # Create the secret for the application
            echo "Creating secret in PreSync phase"
            kubectl create secret generic test-secret \
              --namespace=hook-test \
              --from-literal=username=admin \
              --from-literal=password=t0p-s3cr3t
            echo "Secret creation completed"
          fi
          
          echo "Hook job completed successfully!"
      restartPolicy: Never
  backoffLimit: 2
---
# A simple deployment that uses the secret
apiVersion: apps/v1
kind: Deployment
metadata:
  name: test-app
  namespace: hook-test
spec:
  replicas: 1
  selector:
    matchLabels:
      app: test-app
  template:
    metadata:
      labels:
        app: test-app
    spec:
      containers:
      - name: app
        image: nginx:latest
        env:
        - name: USERNAME
          valueFrom:
            secretKeyRef:
              name: test-secret
              key: username
        - name: PASSWORD
          valueFrom:
            secretKeyRef:
              name: test-secret
              key: password